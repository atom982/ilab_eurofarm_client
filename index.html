<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="shortcut icon" href="/static/favicon.ico" />
  <title>ATOM | Eurofarm Centar</title>
</head>
<script type="text/javascript" src="/static/rsvp-3.1.0.min.js"></script>
<script type="text/javascript" src="/static/sha-256.min.js"></script>
<script type="text/javascript" src="/static/qz-tray.js"></script>
<script type="text/javascript" src="/static/request-cert.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


<body>
  <div id="app"></div>
</body>

<script>
  qz.security.setCertificatePromise(function (resolve, reject) {
    $.ajax({ url: cert, cache: false, dataType: "text" }).then(
      resolve,
      reject
    );
  });

  qz.security.setSignaturePromise(function (toSign) {
    return function (resolve, reject) {
      $.ajax(request + toSign).then(resolve, reject);
    };
  });
  qz.websocket.connect().then(function () { });

  function printEPL(ime, sid, rbr, godiste, datum, link, code, site, prioritet, protokol, svrha, izdavanje) {

    // console.log(sid)

    var Lokacija = ""

    switch (site) {
      // PJC (A), Podružnica Centralna Laboratorija, Sarajevo
      case "5c69f68c338fe912f99f833b": 
        Lokacija = "Centralna Laboratorija"
        break;
      // SJJ (B), Međunarodni aerodrom Sarajevo
      case "5f9f705e444e51a464db2543": 
        Lokacija = "Aerodrom Sarajevo"
        break;
      // TZL (C), Međunarodni aerodrom Tuzla
      case "5f9f70a1444e51a464db259a": 
        Lokacija = "Aerodrom Tuzla"
        break;
      // PSZ (D), Poliklinika Sunce - Zenica
      case "5fb81465900f08738c6985e7": 
        Lokacija = "Poliklinika Sunce"
        break;
      // HLI (E), PZU HBL Laboratorija - Istočno Sarajevo
      case "60508f5ff0a3cf9c7860f5ad": 
        Lokacija = "HBL - Istočno Sarajevo"
        break;
      // HLN (F), HBL Laboratorija - Novo Sarajevo
      case "60508f95f0a3cf9c7860f5bd": 
        Lokacija = "HBL - Novo Sarajevo"
        break;
      // HLD (G), HBL Laboratorija - Dobrinja
      case "60509039f0a3cf9c7860f5e1": 
        Lokacija = "HBL - Dobrinja"
        break;
      // PJU (U), Podružnica 1. Unitic, Sarajevo
      case "6068b249f68be9eab36b4fdb": 
        Lokacija = "Podružnica 1. Unitic"
        break;
      // PJI (Z), PPodružnica Ilidža
      case "6068b2d5f68be9eab36b5003": 
        Lokacija = "Podružnica Ilidža"
        break;
      // PJV (V), Podružnica Visoko
      case "6068b346f68be9eab36b502f": 
        Lokacija = "Podružnica Visoko"
        break;
      // PJT (T), Podružnica Tuzla
      case "6068b3b3f68be9eab36b5088": 
        Lokacija = "Podružnica Tuzla"
        break;
      // PJG (O), Podružnica Goražde
      case "6068b471f68be9eab36b50f5": 
        Lokacija = "Podružnica Goražde"
        break;
      // PJB (P), Podružnica Bugojno
      case "6068b4fcf68be9eab36b511d": 
        Lokacija = "Podružnica Bugojno"
        break;
      // PJR (R), Podružnica Trebinje
      case "6068b55df68be9eab36b5175": 
        Lokacija = "Podružnica Trebinje"
        break;

      default:
        Lokacija = "Nema podataka"
        break;
    }

    // console.log("Lokacija: " + Lokacija)
    // console.log("Nalaz izdati: " + izdavanje)

    var date = datum.slice(8, 10) + "." + datum.slice(5, 7) + "." + datum.slice(0, 4) + " " + datum.slice(-5);
    var labelwidth = 50;
    var labelheight = 25;
    var smallq = "320";
    var bigQ = "200,24";
    var xDiff = 10;
    var yDiff = 10;
    var printer = "";
    var secondprinter = "";
    var purpose = "";
    var str = ""

    if (prioritet === "NORMALAN") {
      // date += "";
    }

    if (prioritet === "HITAN") {
      code = "*" + code;
    }

    // Eurofarm Centar

    if(svrha === "Putovanje"){
      purpose = "Putovanje"
    }else if(svrha === "Procjena zdravstvenog stanja"){
      purpose = "Procjena"
    }else if(svrha === "Kontakt sa zaraženom osobom"){
      purpose = "Kontakt"
    }else{
      purpose = "*"
    }

    // console.log("Protokol: " + protokol)
    // console.log("Svrha: " + purpose)

    qz.printers
      .find()
      .then(function (data) {
        var list = [];

        for (var i = 0; i < data.length; i++) {
          list.push(data[i]);
        }

        var condition = false

        list.forEach((element) => {
          // console.log(element)

          // ZDesigner GC420t (EPL)
          // \\\SAV-LAB-01.ad.poliklinika-atrijum.ba\\ZDesigner GC420t (EPL)
          
          if (element === "Zebra") {
            condition = true
            printer = "Zebra";
          } else if (element === "WizardLAB(ZPL)") {
            condition = true
            printer = "WizardLAB(ZPL)";
          } else {
            if (condition === false) {
              printer = "\\\laboratorija-pc\\Zebra";
            }
          }
        });

        var Korekcija = "                    ";

        if (protokol != undefined && protokol != null && protokol != "") {
          str = 'A28,161,0,2,1,1,N,"' + sid + "(" + protokol + ")" + Korekcija + '"\n'
        } else{
          str = 'A28,161,0,2,1,1,N,"' + sid + Korekcija + '"\n'
        }

        if (printer === "Zebra" || printer === "WizardLAB(ZPL)" || printer === "\\\laboratorija-pc\\Zebra") {
          console.warn("Zebra printer found.");

          var config = qz.configs.create(printer, {
            size: {
              width: labelwidth,
              height: labelheight,
            },
            units: "mm",
          });

          qz.print(config, [
            "\nN\n",
            "q" + smallq + "\n",
            "Q" + bigQ + "\n",
            "I8,B\n",

            {
              type: "raw",
              format: "image",
              data: link,
              options: {
                language: "EPL",
                x: xDiff,
                y: yDiff,
              },
            },

            'A28,0,0,2,1,1,N,"' + Lokacija + '"\n',
            'A28,20,0,2,1,1,N,"' + ime + Korekcija + '"\n',
            'A28,40,0,2,1,1,N,"' + godiste + "(" + purpose + ")" + Korekcija + '"\n',
            'A28,56,0,2,1,1,N,"' + code + "(" + izdavanje + ")" + Korekcija + '"\n',            
            'A28,144,0,2,1,1,N,"' + date + " sati" + Korekcija + '"\n',

              str,

            "X28,17,1,296,17\n",
            "X28,37,1,296,37\n",
            "\nP1,1\n",

          ]).catch(function (e) {
            console.error(e);
          });
        } else {
          console.warn("Zebra printer not found.");

          var config = qz.configs.create(secondprinter, {
            size: {
              width: labelwidth,
              height: labelheight,
            },
            units: "mm",
          });

          qz.print(config, [
            "\nN\n",
            "q" + smallq + "\n",
            "Q" + bigQ + "\n",
            "I8,B\n",

            {
              type: "raw",
              format: "image",
              data: link,
              options: {
                language: "EPL",
                x: xDiff,
                y: yDiff,
              },
            },

            'A28,0,0,2,1,1,N,"' + Lokacija + '"\n',
            'A28,20,0,2,1,1,N,"' + ime + Korekcija + '"\n',
            'A28,40,0,2,1,1,N,"' + godiste + "(" + purpose + ")" + Korekcija + '"\n',
            'A28,56,0,2,1,1,N,"' + code + "(" + izdavanje + ")" + Korekcija + '"\n',            
            'A28,144,0,2,1,1,N,"' + date + " sati" + Korekcija + '"\n',

              str,

            "X28,17,1,296,17\n",
            "X28,37,1,296,37\n",
            "\nP1,1\n",

          ]).catch(function (e) {
            console.error(e);
          });
        }
      })
      .catch(function (e) {
        console.error(e);
      });
  }
</script>

</html>